<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Musiq Studio on Pi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <style>
    body{font-family:system-ui,Arial,sans-serif; margin:24px; color:#222;}
    h1{margin:0 0 8px}
    .row{display:flex; gap:8px; flex-wrap:wrap; margin:12px 0}
    .btn{padding:10px 14px; border-radius:8px; border:1px solid #ddd; background:#fafafa; cursor:pointer}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    #status{margin:8px 0 16px; padding:8px 10px; background:#f7f7ff; border:1px solid #e6e6ff; border-radius:8px}
    footer{margin-top:40px; padding-top:12px; border-top:1px solid #eee; font-size:13px; color:#666}
    footer a{color:#6A1B9A; text-decoration:none}
    footer a:hover{text-decoration:underline}
    audio{margin-top:10px; display:none}
  </style>
</head>
<body>
  <h1>🎶 Musiq Studio on Pi</h1>
  <p id="status">Initializing…</p>

  <div class="row">
    <button class="btn" id="btn-login">Login with Pi</button>
    <button class="btn" id="btn-load">Load Track</button>
    <button class="btn" id="btn-record">Record / Stop</button>
    <button class="btn" id="btn-mint">Mint NFT (1π sandbox)</button>
    <button class="btn" id="btn-market">Market</button>
  </div>

  <audio id="preview-audio" controls></audio>

  <!-- Debug Bar (no console needed) -->
  <div id="debug-bar" style="position:fixed;left:0;right:0;bottom:0;max-height:35vh;overflow:auto;background:#111;color:#fff;font:12px monospace;z-index:9999;padding:6px"></div>
  <script>
    window.dbg = (msg) => {
      const bar = document.getElementById("debug-bar");
      const line = document.createElement("div");
      line.textContent = new Date().toLocaleTimeString() + " — " + msg;
      bar.appendChild(line);
      while (bar.childNodes.length > 120) bar.removeChild(bar.firstChild);
      try{ console.log(msg); }catch(_) {}
    };
  </script>

  <!-- BEGIN APP SCRIPT -->
  <script>
    /* ---------- helpers ---------- */
    const $ = (id) => document.getElementById(id);
    function setStatus(html){ const s=$("status"); if(s) s.innerHTML = html; }
    function enableActions(en){
      ["btn-load","btn-record","btn-mint","btn-market"].forEach(id=>{ const el=$(id); if(el) el.disabled=!en; });
    }

    /* ---------- state ---------- */
    let currentUser = null;
    let mediaRecorder=null, mediaStream=null, recordedChunks=[], recording=false;

    /* ---------- Pi init ---------- */
    function initPi(){
      if(!window.Pi){ setStatus("❌ SDK not loaded"); return; }
      try{
        Pi.init({ version:"2.0", sandbox:true });
        setStatus("✅ Pi SDK initialized (sandbox)");
      }catch(e){ setStatus("❌ Pi.init failed"); dbg("Pi.init error: "+e); }
    }

    /* ---------- login (username + payments) ---------- */
    async function loginWithPi(){
      if(!window.Pi){ alert("Pi SDK not ready. Open in Pi Browser."); return; }
      try{
        const auth = await Pi.authenticate(['username','payments']);
        currentUser = auth?.user || null;
        const name = currentUser?.username || "Pioneer";
        setStatus(`✅ Logged in as ${name} 🎉`);
        enableActions(true);
        dbg("Auth success for "+name);
      }catch(e){
        dbg("Auth error: "+(e?.message||e));
        alert("Login failed: "+(e?.message||e));
      }
    }

    /* ---------- ensure payments scope ---------- */
    async function ensurePaymentsScope(){
      try{
        await Pi.authenticate(['payments']); // no-op if already granted
        return true;
      }catch(e){
        alert("Mint requires 'payments' permission in Pi Browser.");
        dbg("ensurePaymentsScope error: "+(e?.message||e));
        return false;
      }
    }

    /* ---------- Mint with full logging ---------- */
    async function onMintNft(){
      if(!currentUser){ alert("Please login first."); return; }
      if(!(await ensurePaymentsScope())) return;

      const paymentData = { amount:1, memo:"Musiq Studio – Mint demo", metadata:{ feature:"mint_demo" } };
      dbg("[CLIENT] createPayment start "+JSON.stringify(paymentData));

      try{
        await Pi.createPayment(paymentData, {
          onReadyForServerApproval: async (paymentId) => {
            setStatus("⏳ Approving payment…");
            dbg("[CLIENT] Approve start paymentId="+paymentId);
            try{
              const r = await fetch('/.netlify/functions/approve-payment', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ paymentId })
              });
              const t = await r.text();
              dbg("[CLIENT] Approve response "+r.status+" "+t);
              if(!r.ok){ setStatus(`❌ Approve failed: ${r.status}`); alert(`Approve failed: ${r.status}\n${t}`); return; }
            }catch(err){ dbg("[CLIENT] Approve fetch error: "+(err?.message||err)); setStatus("❌ Approve fetch error"); }
          },
          onReadyForServerCompletion: async (paymentId, txId) => {
            setStatus("⏳ Completing payment…");
            dbg("[CLIENT] Complete start paymentId="+paymentId+" txId="+(txId||"none"));
            try{
              const r = await fetch('/.netlify/functions/complete-payment', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ paymentId, txId })
              });
              const t = await r.text();
              dbg("[CLIENT] Complete response "+r.status+" "+t);
              if(!r.ok){ setStatus(`❌ Complete failed: ${r.status}`); alert(`Complete failed: ${r.status}\n${t}`); return; }
              setStatus(`✅ Payment completed! ID: ${paymentId}${txId ? `, tx: ${txId}` : ""}`);
              dbg("[CLIENT] Payment flow finished ✅");
            }catch(err){ dbg("[CLIENT] Complete fetch error: "+(err?.message||err)); setStatus("❌ Complete fetch error"); }
          },
          onCancel: (paymentId) => { dbg("[CLIENT] Payment cancelled "+(paymentId||"")); setStatus("❌ Payment cancelled."); },
          onError: (error, paymentId) => {
            const msg=(error?.message||String(error)); dbg("[CLIENT] Payment error "+(paymentId||"")+" "+msg);
            setStatus("❌ Payment error: "+msg); alert("Payment error: "+msg);
          }
        });
      }catch(e){ dbg("[CLIENT] createPayment threw: "+(e?.message||e)); alert("Mint failed: "+(e?.message||e)); }
    }

    /* ---------- simple audio actions ---------- */
    function onLoadTrack(){
      const input=document.createElement("input"); input.type="file"; input.accept="audio/*";
      input.onchange=()=>{ const f=input.files?.[0]; if(!f) return;
        const url=URL.createObjectURL(f); const audio=$("preview-audio");
        if(audio){ audio.src=url; audio.style.display="block"; audio.play().catch(()=>{}); }
        setStatus("📂 Loaded: "+f.name);
      };
      input.click();
    }
    async function toggleRecord(){
      if(!recording){
        try{
          const s = await navigator.mediaDevices.getUserMedia({audio:true});
          mediaStream=s; recordedChunks=[]; mediaRecorder=new MediaRecorder(s);
          mediaRecorder.ondataavailable=e=>{ if(e.data.size) recordedChunks.push(e.data); };
          mediaRecorder.onstop=()=>{ const blob=new Blob(recordedChunks,{type:"audio/webm"});
            const url=URL.createObjectURL(blob); const audio=$("preview-audio");
            if(audio){ audio.src=url; audio.style.display="block"; }
            setStatus("⏹️ Recording stopped; preview ready."); };
          mediaRecorder.start(); recording=true; setStatus("🎤 Recording…");
        }catch(e){ alert("Mic permission failed."); }
      }else{
        mediaRecorder?.stop(); mediaStream?.getTracks()?.forEach(t=>t.stop()); recording=false;
      }
    }

    /* ---------- nav ---------- */
    function goMarket(){ location.href="/market.html"; }

    /* ---------- wire up ---------- */
    window.addEventListener("load", ()=>{
      initPi();
      enableActions(false);
      $("btn-login").onclick = loginWithPi;
      $("btn-load").onclick  = onLoadTrack;
      $("btn-record").onclick= toggleRecord;
      $("btn-mint").onclick  = onMintNft;
      $("btn-market").onclick= goMarket;

      // warn if not in Pi Browser
      const ua = navigator.userAgent||""; if(!/PiBrowser/i.test(ua)){
        const w=document.createElement('div');
        w.style.cssText="position:fixed;left:0;right:0;top:0;background:#ffefef;color:#8a0000;padding:8px;border-bottom:1px solid #e0bcbc;z-index:99999";
        w.textContent="Open this site in the Pi Browser app for login/payments.";
        document.body.appendChild(w);
      }
    });
  </script>
  <!-- END APP SCRIPT -->

  <footer>
    <p><a href="/privacy.html">Privacy Policy</a> · <a href="/terms.html">Terms of Use</a></p>
    <p class="tiny">© 2025 Musiq Studio on Pi</p>
  </footer>
</body>
</html>
