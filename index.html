<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Musiq Studio on Pi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Pi SDK (works only in Pi Browser) -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <!-- Minimal styling (keep or replace with your own) -->
  <style>
    :root {
      --brand: #6A1B9A;
      --brand-dark: #520a9c;
      --text: #222;
      --muted: #666;
      --bg: #f9f9f9;
      --ok: #0a6b42;
      --bad: #7a0012;
    }
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }
    h1 { margin: 8px 0 0; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    .btn {
      padding: 12px 20px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      color: #fff;
      background: var(--brand);
      cursor: pointer;
      transition: background .2s ease, opacity .2s ease;
    }
    .btn:hover { background: var(--brand-dark); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.06);
      width: min(900px, 95vw);
    }
    #status { color: var(--muted); margin: 8px 0 0; }
    
    
    


/* üîî Audio Studio timer styles */

#rec-panel {
  display: inline-block;
  padding: 8px 12px;
  border-radius: 10px;
  background: #f3f3ff;
  color: #333;
  font-weight: 600;
}
#rec-status.rec {
  color: #0a6b42;      /* green while recording */
}
#rec-status.stop {
  color: #7a0012;      /* red-ish when stopped */
}
#rec-timer { letter-spacing: 1px; }


    #welcome-message { font-weight: bold; margin: 0; }
    #preview-audio { width: 100%; margin-top: 12px; display: none; }
    .pill {
      display: inline-block; padding: 6px 10px; border-radius: 999px; font-size: 13px;
      background: #eef7f0; color: var(--ok);
    }
    .pill.bad { background: #fde7ea; color: var(--bad); }
    .tiny { font-size: 12px; color: var(--muted); }
  </style>
</head>

<body>
  <h1>Musiq Studio &#127926; <!-- üé∂ --></h1>

  <!-- Auth card -->
  <div class="card">
    <div class="row">
      <button class="btn" id="btn-login" onclick="loginWithPi()">Login with Pi</button>
      <span class="pill" id="sdk-pill">Checking Pi SDK‚Ä¶</span>
    </div>
    <p id="welcome-message"></p>
    <p id="status">Initializing‚Ä¶</p>

    <!-- Self-check UI -->
<div id="pi-sandbox-check" style="margin:12px 0; font-size:14px;"></div>

  
  </div>

  <!-- Actions card -->
  <div class="card">
    <h3 style="margin-top:0;">Studio Actions</h3>
    <div class="row" id="actions">
      <button class="btn" id="btn-load" disabled>Load Track</button>

      <!-- Record toggle (label switches to Stop) -->
      <button class="btn" id="btn-record" disabled>Record &#127908;</button> <!-- üé§ -->

      <!-- Optional explicit pair; keep if you want both patterns -->
      <button class="btn" id="btn-start-recording" disabled>Start Recording &#127908;</button>
      <button class="btn" id="btn-stop-recording" disabled>Stop &#9724;&#65039;</button> <!-- ‚èπÔ∏è -->

      <button class="btn" id="btn-mint" disabled>Mint NFT</button>
      <button class="btn" id="btn-market" disabled>Market</button>
      <button class="btn" id="btn-pi-total" disabled>Pi Total: 0 &pi;</button>
    </div>
    <!-- Audio Studio: live recording timer -->
<div id="audio-studio" style="margin-top:12px;">
  <h3 style="margin:0 0 6px;">Audio Studio</h3>
  <div id="rec-panel">
    <span id="rec-status">Idle</span> ‚Äî <span id="rec-timer">00:00</span>
  </div>
</div>


    <audio id="preview-audio" controls></audio>
    <p class="tiny">Tip: Actions enable after login.</p>
  </div>

  <!-- Special Characters quick ref -->

  <!-- BEGIN APP SCRIPT -->
<script>
/* ---------- tiny helpers ---------- */
const $ = (id) => document.getElementById(id);
function setStatus(msg){ const s = $("status"); if (s) s.innerHTML = msg; }
function log(msg){ try{ console.log(msg); }catch(_){} }

/* ---------- global state ---------- */
let currentUser = null;

/* ---------- enable/disable studio actions ---------- */
function enableActions(enabled){
  [
    "btn-load",
    "btn-record",
    "btn-start-recording",
    "btn-stop-recording",
    "btn-mint",
    "btn-market",
    "btn-pi-total",
    "btn-clear-minted" // ok if you don't have it; ignored
  ].forEach(id=>{
    const el = $(id);
    if (el) el.disabled = !enabled;
  });
}

/* ---------- Pi SDK init (sandbox) ---------- */
function initPiSdk(){
  if (!window.Pi){ setStatus("‚ùå SDK: Not Loaded"); return; }
  try {
    Pi.init({ version: "2.0", sandbox: true });
    setStatus("‚úÖ Pi SDK initialized (sandbox)");
  } catch (e) {
    console.error(e);
    setStatus("‚ùå Pi.init failed");
  }
}

/* ---------- login (requests username + payments) ---------- */
async function loginWithPi(){
  if (!window.Pi){ alert("Pi SDK not ready. Open in Pi Browser."); return; }
  try {
    const scopes = ['username','payments']; // <-- IMPORTANT
    const auth = await Pi.authenticate(scopes);

    currentUser = auth?.user || null;
    const username = currentUser?.username || "Pioneer";
    setStatus(`‚úÖ Logged in as ${username} üéâ`);
    enableActions(true);
    log("Auth success: " + username);
  } catch (e) {
    console.error("Auth error:", e);
    alert("Login failed: " + (e?.message || e));
  }
}

/* ---------- guard to ensure we have payments scope ---------- */
async function ensurePaymentsScope(){
  // Some SDKs expose granted scopes on the auth result; to be safe, reprompt if createPayment rejects.
  try {
    // quick no-op call to see if API exists
    if (!Pi.createPayment) throw new Error("Payments API not available");
    return true;
  } catch {
    try {
      await Pi.authenticate(['payments']);
      return true;
    } catch (e) {
      alert("Mint requires the 'payments' permission in Pi Browser.");
      return false;
    }
  }
}

/* ---------- Mint NFT (sandbox) ---------- */
async function onMintNft(){
  if (!currentUser){ alert("Please login first."); return; }
  if (!(await ensurePaymentsScope())) return;

  try {
    const paymentData = {
      // sandbox-friendly demo payment
      amount: 1,
      memo: "Musiq Studio ‚Äì Mint demo",
      metadata: { feature: "mint_demo", user: currentUser.username }
    };

    await Pi.createPayment(paymentData, {
      onReadyForServerApproval: async (paymentId) => {
  setStatus("‚è≥ Approving payment‚Ä¶");
  console.log("[CLIENT] Approve start", { paymentId });

  const r = await fetch('/.netlify/functions/approve-payment', {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({ paymentId })
  });

  const t = await r.text();
  console.log("[CLIENT] Approve response", r.status, t);
  if (!r.ok) {
    setStatus(`‚ùå Approve failed: ${r.status}`);
    alert(`Approve failed: ${r.status}\n${t}`);
    // Optionally cancel here:
    // Pi.cancelPayment(paymentId);
    return;
  }
},

 onReadyForServerCompletion: async (paymentId, txId) => {
  setStatus("‚è≥ Completing payment‚Ä¶");
  console.log("[CLIENT] Complete start", { paymentId, txId });

  const r = await fetch('/.netlify/functions/complete-payment', {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({ paymentId, txId })
  });

  const t = await r.text();
  console.log("[CLIENT] Complete response", r.status, t);
  if (!r.ok) {
    setStatus(`‚ùå Complete failed: ${r.status}`);
    alert(`Complete failed: ${r.status}\n${t}`);
    return;
  }

  setStatus(`‚úÖ Payment completed! ID: ${paymentId}${txId ? `, tx: ${txId}` : ""}`);
},

  onCancel: (paymentId) => {
        log("Payment cancelled: " + paymentId);
        setStatus("‚ùå Payment cancelled.");
      },
      onError: (error, paymentId) => {
        console.error("Payment error:", error, paymentId);
        setStatus("‚ùå Payment error: " + (error?.message || error));
        alert("Payment error: " + (error?.message || error));
      }
    });

  } catch (e) {
    console.error("Mint error:", e);
    alert("Mint failed: " + (e?.message || e));
  }
}

/* ---------- simple stubs so buttons don't error ---------- */
function onLoadTrack(){
  // Opens a file picker and previews audio if you have <audio id="preview-audio">
  const input = document.createElement("input");
  input.type = "file"; input.accept = "audio/*";
  input.onchange = () => {
    const f = input.files?.[0]; if (!f) return;
    const url = URL.createObjectURL(f);
    const audio = $("preview-audio");
    if (audio){ audio.src = url; audio.style.display = "block"; audio.play().catch(()=>{}); }
    setStatus("üìÇ Loaded: " + f.name);
  };
  input.click();
}
let mediaRecorder = null, mediaStream = null, recordedChunks = [], recording = false;
async function startRecording(){
  try{
    if (recording) return;
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaStream = stream; recordedChunks = [];
    mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });
    mediaRecorder.ondataavailable = e => { if (e.data.size) recordedChunks.push(e.data); };
    mediaRecorder.onstop = () => {
      const blob = new Blob(recordedChunks, { type: "audio/webm" });
      const url = URL.createObjectURL(blob);
      const audio = $("preview-audio");
      if (audio){ audio.src = url; audio.style.display = "block"; }
      setStatus("‚èπÔ∏è Recording stopped; preview ready.");
    };
    mediaRecorder.start();
    recording = true;
    setStatus("üé§ Recording‚Ä¶");
  }catch(e){
    console.error(e);
    alert("Mic permission failed.");
  }
}
function stopRecording(){
  if (!recording) return;
  mediaRecorder?.stop();
  mediaStream?.getTracks()?.forEach(t=>t.stop());
  recording = false;
}
function onToggleRecord(){ recording ? stopRecording() : startRecording(); }
function onMarket(){ location.href = "/market.html"; }
function onPiTotal(){ alert("Pi Total (placeholder)"); }

/* ---------- wire up on load ---------- */
window.addEventListener("load", () => {
  initPiSdk();
  enableActions(false); // locked until login

  // Hook up buttons if they exist in your HTML
  $("btn-login") && ($("btn-login").onclick = loginWithPi);
  $("btn-mint") && ($("btn-mint").onclick = onMintNft);
  $("btn-load") && ($("btn-load").onclick = onLoadTrack);
  $("btn-record") && ($("btn-record").onclick = onToggleRecord);
  $("btn-start-recording") && ($("btn-start-recording").onclick = startRecording);
  $("btn-stop-recording") && ($("btn-stop-recording").onclick = stopRecording);
  $("btn-market") && ($("btn-market").onclick = onMarket);
  $("btn-pi-total") && ($("btn-pi-total").onclick = onPiTotal);
});
</script>
<!-- END APP SCRIPT -->



<script>
  async function runPiSandboxCheck() {
    const el = document.getElementById('pi-sandbox-check');
    const rows = [];
    function row(ok, msg){ rows.push(`<div>${ok ? '‚úÖ' : '‚ùå'} ${msg}</div>`); }

    // 1) Pi Browser / SDK
    const isPiBrowser = /PiBrowser/i.test(navigator.userAgent);
    row(isPiBrowser, `Pi Browser detected (${navigator.userAgent})`);
    const sdkLoaded = !!window.Pi;
    row(sdkLoaded, 'Pi SDK loaded (window.Pi)');

    // 2) Init sanity
    let initOK = false;
    try { 
      if (sdkLoaded) { Pi.init({ version: "2.0", sandbox: true }); initOK = true; } 
    } catch(e){}
    row(initOK, 'Pi.init executed (sandbox mode)');

    // 3) Auth + Payments present
    row(!!(sdkLoaded && Pi.authenticate), 'Pi.authenticate available');
    row(!!(sdkLoaded && Pi.createPayment), 'Pi.createPayment available');

    // 4) Legal pages + validation key
    async function urlOk(u){
      try { const r = await fetch(u, {method:'HEAD'}); return r.ok; } catch { return false; }
    }
    const privacyOk = await urlOk('/privacy.html');
    row(privacyOk, 'Privacy Policy reachable (/privacy.html)');
    const termsOk = await urlOk('/terms.html');
    row(termsOk, 'Terms reachable (/terms.html)');
    const valOk = await urlOk('/validation-key.txt');
    row(valOk, 'validation-key.txt reachable');

    el.innerHTML = `<div style="padding:10px;border:1px solid #eee;border-radius:8px;background:#fafafa">
      <strong>Pi Sandbox Readiness</strong>
      ${rows.join('')}
    </div>`;
    console.log('Pi Sandbox Readiness Report:\n' + rows.map(r=>r.replace(/<[^>]*>/g,'')).join('\n'));
  }
  window.addEventListener('load', runPiSandboxCheck);
</script>
<footer style="margin-top:40px; padding:12px; font-size:13px; text-align:center; color:#666; border-top:1px solid #eee;">
  <p>
    <a href="/privacy.html" style="color:#6A1B9A; text-decoration:none;">Privacy Policy</a> ¬∑
    <a href="/terms.html" style="color:#6A1B9A; text-decoration:none;">Terms of Use</a>
  </p>
  <p class="tiny">¬© 2025 Musiq Studio on Pi</p>
</footer>

</body>
</html>
