<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Musiq Studio on Pi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Pi SDK (works only in Pi Browser) -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <!-- Minimal styling (keep or replace with your own) -->
  <style>
    :root {
      --brand: #6A1B9A;
      --brand-dark: #520a9c;
      --text: #222;
      --muted: #666;
      --bg: #f9f9f9;
      --ok: #0a6b42;
      --bad: #7a0012;
    }
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }
    h1 { margin: 8px 0 0; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    .btn {
      padding: 12px 20px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      color: #fff;
      background: var(--brand);
      cursor: pointer;
      transition: background .2s ease, opacity .2s ease;
    }
    .btn:hover { background: var(--brand-dark); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.06);
      width: min(900px, 95vw);
    }
    #status { color: var(--muted); margin: 8px 0 0; }
    
    
    


/* 🔔 Audio Studio timer styles */

#rec-panel {
  display: inline-block;
  padding: 8px 12px;
  border-radius: 10px;
  background: #f3f3ff;
  color: #333;
  font-weight: 600;
}
#rec-status.rec {
  color: #0a6b42;      /* green while recording */
}
#rec-status.stop {
  color: #7a0012;      /* red-ish when stopped */
}
#rec-timer { letter-spacing: 1px; }


    #welcome-message { font-weight: bold; margin: 0; }
    #preview-audio { width: 100%; margin-top: 12px; display: none; }
    .pill {
      display: inline-block; padding: 6px 10px; border-radius: 999px; font-size: 13px;
      background: #eef7f0; color: var(--ok);
    }
    .pill.bad { background: #fde7ea; color: var(--bad); }
    .tiny { font-size: 12px; color: var(--muted); }
  </style>
</head>

<body>
  <h1>Musiq Studio &#127926; <!-- 🎶 --></h1>

  <!-- Auth card -->
  <div class="card">
    <div class="row">
      <button class="btn" id="btn-login" onclick="loginWithPi()">Login with Pi</button>
      <span class="pill" id="sdk-pill">Checking Pi SDK…</span>
    </div>
    <p id="welcome-message"></p>
    <p id="status">Initializing…</p>

    <!-- Self-check UI -->
<div id="pi-sandbox-check" style="margin:12px 0; font-size:14px;"></div>

  
  </div>

  <!-- Actions card -->
  <div class="card">
    <h3 style="margin-top:0;">Studio Actions</h3>
    <div class="row" id="actions">
      <button class="btn" id="btn-load" disabled>Load Track</button>

      <!-- Record toggle (label switches to Stop) -->
      <button class="btn" id="btn-record" disabled>Record &#127908;</button> <!-- 🎤 -->

      <!-- Optional explicit pair; keep if you want both patterns -->
      <button class="btn" id="btn-start-recording" disabled>Start Recording &#127908;</button>
      <button class="btn" id="btn-stop-recording" disabled>Stop &#9724;&#65039;</button> <!-- ⏹️ -->

      <button class="btn" id="btn-mint" disabled>Mint NFT</button>
      <button class="btn" id="btn-market" disabled>Market</button>
      <button class="btn" id="btn-pi-total" disabled>Pi Total: 0 &pi;</button>
    </div>
    <!-- Audio Studio: live recording timer -->
<div id="audio-studio" style="margin-top:12px;">
  <h3 style="margin:0 0 6px;">Audio Studio</h3>
  <div id="rec-panel">
    <span id="rec-status">Idle</span> — <span id="rec-timer">00:00</span>
  </div>
</div>


    <audio id="preview-audio" controls></audio>
    <p class="tiny">Tip: Actions enable after login.</p>
  </div>

  <!-- Special Characters quick ref -->


  <!-- App logic -->
  <script>
    // ---------- State ----------
    let currentUser = null;
    let mediaStream = null;
    let mediaRecorder = null;
    let recording = false;
    let recordedChunks = [];
// --- Audio Studio timer state ---
let recInterval = null;   // setInterval handle
let recStartMs = 0;       // when the current recording started
let elapsedMs = 0;        // last measured duration (kept when stopped)

function setRecStatus(txt, cls = "") {
  const s = document.getElementById("rec-status");
  if (!s) return;
  s.textContent = txt;
  s.className = cls ? cls : "";
}

function setRecTime(ms) {
  const t = document.getElementById("rec-timer");
  if (!t) return;
  const totalSec = Math.floor(ms / 1000);
  const mm = String(Math.floor(totalSec / 60)).padStart(2, "0");
  const ss = String(totalSec % 60).padStart(2, "0");
  t.textContent = `${mm}:${ss}`;
}

function startTimer() {
  // fresh start
  elapsedMs = 0;
  recStartMs = Date.now();
  setRecStatus("Recording… 🎤", "rec");
  setRecTime(0);

  recInterval = setInterval(() => {
    const now = Date.now();
    const ms = now - recStartMs;
    setRecTime(ms);
  }, 250);
}

function stopTimer() {
  if (recInterval) {
    clearInterval(recInterval);
    recInterval = null;
  }
  // freeze display at final elapsed
  elapsedMs = Date.now() - recStartMs;
  setRecStatus("Stopped ⏹️", "stop");
}


    // Local "Pi Total" placeholder (until real payments)
    const PiTotal = {
      key: 'musiq-pi-total',
      get() { return Number(localStorage.getItem(this.key) || '0'); },
      set(v) { localStorage.setItem(this.key, String(v)); updatePiTotalUI(); }
    };

    // Lightweight activity log (localStorage)
    const Activity = {
      key: 'musiq-activity-log',
      log: JSON.parse(localStorage.getItem('musiq-activity-log') || '[]'),
      add(event, data = {}) {
        const entry = {
          ts: new Date().toISOString(),
          event,
          user: currentUser?.username || null,
          ...data
        };
        this.log.push(entry);
        localStorage.setItem(this.key, JSON.stringify(this.log));
        console.log('📒 Activity:', entry);
      },
      dump() { return this.log; },
      clear() { this.log = []; localStorage.removeItem(this.key); }
    };

    // ---------- Init SDK after load ----------
    window.addEventListener("load", () => {
      if (window.Pi) {
        try {
          Pi.init({ version: "2.0", sandbox: true }); // sandbox ON while building
          log("&#9989; Pi SDK initialized (sandbox)");
          setPill("SDK: Ready", true);
        } catch (e) {
          log("&#10060; Pi.init failed: " + (e?.message || e));
          setPill("SDK: Init Error", false);
        }
      } else {
        log("&#10060; Pi SDK not loaded — open in Pi Browser");
        setPill("SDK: Not Loaded", false);
      }

      // Wire handlers (enable after login)
      byId("btn-load").onclick = onLoadTrack;

      // Toggle (Record <-> Stop)
      byId("btn-record").onclick = onToggleRecord;

      // Two-button pair (optional)
      byId("btn-start-recording").onclick = startRecording;
      byId("btn-stop-recording").onclick  = stopRecording;

      byId("btn-mint").onclick   = onMintNft;
      byId("btn-market").onclick = onMarket;
      byId("btn-pi-total").onclick = showPiTotal;

      updatePiTotalUI();
    });

    async function loginWithPi() {
  if (!window.Pi) {
    alert("Pi SDK not ready. Open in Pi Browser.");
    return;
  }
  try {
    // ✅ Now ask for both username + payments
    const scopes = ['username', 'payments'];
    const auth = await Pi.authenticate(scopes);

    // Show success in your UI
    const user = auth?.user?.username || 'Pioneer';
    document.getElementById("status").textContent = `✅ Logged in as ${user}`;
    console.log("Auth success:", auth);

    // (Re-enable buttons or other UI here if you disabled them before login)

  } catch (e) {
    console.error("Auth error:", e);
    alert("Login failed: " + (e?.message || e));
  }
}


    function enableActions(enabled) {
      [
        "btn-load",
        "btn-record",
        "btn-start-recording",
        "btn-stop-recording",
        "btn-mint",
        "btn-market",
        "btn-pi-total"
      ].forEach(id => {
        const el = byId(id);
        if (el) el.disabled = !enabled;
      });
    }

    // ---------- Load track (file picker + preview) ----------
    function onLoadTrack() {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "audio/*";
      input.onchange = () => {
        const file = input.files?.[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        const audio = byId("preview-audio");
        audio.src = url;
        audio.style.display = "block";
        audio.play().catch(()=>{});
        log(`📂 Loaded: ${file.name}`);
        Activity.add('load_track', { name: file.name, size: file.size });
      };
      input.click();
    }

    // ---------- Record: one-button toggle ----------
    async function onToggleRecord() {
      if (!recording) {
        await startRecording();
        byId("btn-record").innerHTML = "Stop &#9724;&#65039;"; // ⏹️
      } else {
        await stopRecording();
        byId("btn-record").innerHTML = "Record &#127908;"; // 🎤
      }
    }

    // ---------- Record: explicit start/stop (optional pair) ----------
    async function startRecording() {
      try {
        if (recording) return;
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaStream = stream;
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });
        mediaRecorder.ondataavailable = e => { if (e.data.size) recordedChunks.push(e.data); };
        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: "audio/webm" });
          const url = URL.createObjectURL(blob);
          const audio = byId("preview-audio");
          audio.src = url;
          audio.style.display = "block";
          log("⏹️ Recording stopped; preview ready.");
          Activity.add('record_stop', { bytes: blob.size });
        };
        mediaRecorder.start();
        recording = true;
    // 🔔 START the Audio Studio 
    startTimer();

        log("🎤 Recording…");
        Activity.add('record_start');
      } catch (e) {
        console.error(e);
        alert("Mic permission failed. Check browser settings.");
        log("&#10060; Mic error");
        Activity.add('record_error', { error: String(e?.message || e) });
      }
    }

    async function stopRecording() {
      if (!recording) return;
      mediaRecorder?.stop();
      mediaStream?.getTracks()?.forEach(t => t.stop());
      recording = false;

     // 🔔 STOP the Audio Studio 
     stopTimer();

  }

    // ---------- Mint NFT: sandbox payment flow ----------
    async function onMintNft() {
      try {
        if (!window.Pi) return alert("Pi SDK not ready. Use Pi Browser.");
        Activity.add('mint_click');
        await Pi.createPayment({
          amount: 1, // 1 π (sandbox)
          memo: "Mint NFT &#127926;", // 🎶
          metadata: { type: "mint", item: "nft_demo_1" }
        }, {
          onReadyForServerApproval: (paymentId) => {
            log("📝 Ready for server approval: " + paymentId);
            Activity.add('payment_ready_for_approval', { paymentId });
            // TODO: send paymentId to your backend for approval
          },
          onReadyForServerCompletion: (paymentId, txId) => {
            log("&#9989; Payment completed! ID: " + paymentId + ", tx: " + txId);
            Activity.add('payment_completed', { paymentId, txId });
            PiTotal.set(PiTotal.get() + 1); // Local placeholder counter
          },
          onCancel: (paymentId) => {
            log("&#10060; Payment cancelled: " + paymentId);
            Activity.add('payment_cancelled', { paymentId });
          },
          onError: (error, paymentId) => {
            log("⚠️ Payment error: " + error + " (ID: " + paymentId + ")");
            Activity.add('payment_error', { paymentId, error: String(error) });
          }
        });
      } catch (err) {
        console.error("Payment failed:", err);
        alert("Mint failed: " + (err?.message || err));
        log("&#10060; Mint failed: " + (err?.message || err));
        Activity.add('mint_failed', { error: String(err?.message || err) });
      }
    }

    // ---------- Market (placeholder) ----------
    function onMarket() {
      alert("Market page coming soon.");
      log("🛍️ Market placeholder");
      Activity.add('market_click');
      // e.g., location.href = "/market.html";
    }

    // ---------- Pi Total (placeholder) ----------
    function showPiTotal() {
      alert(`Pi Total (local placeholder): ${PiTotal.get()} \u03C0`);
      log(`ℹ️ Pi Total shown: ${PiTotal.get()} π (placeholder)`);
      Activity.add('pi_total_view', { total: PiTotal.get() });
    }

    function updatePiTotalUI() {
      const btn = byId("btn-pi-total");
      if (btn) btn.textContent = `Pi Total: ${PiTotal.get()} \u03C0`;
    }

    // ---------- Helpers ----------
    function byId(id){ return document.getElementById(id); }
    function log(msg){
      console.log(msg);
      const el = byId("status");
      if (el) el.innerHTML = msg;
    }
    function setPill(text, ok) {
      const pill = byId("sdk-pill");
      if (!pill) return;
      pill.textContent = text;
      pill.className = "pill" + (ok ? "" : " bad");
    }

    // For console:
    // Activity.dump()  -> view log
    // Activity.clear() -> clear log
  </script>
<script>
  async function runPiSandboxCheck() {
    const el = document.getElementById('pi-sandbox-check');
    const rows = [];
    function row(ok, msg){ rows.push(`<div>${ok ? '✅' : '❌'} ${msg}</div>`); }

    // 1) Pi Browser / SDK
    const isPiBrowser = /PiBrowser/i.test(navigator.userAgent);
    row(isPiBrowser, `Pi Browser detected (${navigator.userAgent})`);
    const sdkLoaded = !!window.Pi;
    row(sdkLoaded, 'Pi SDK loaded (window.Pi)');

    // 2) Init sanity
    let initOK = false;
    try { 
      if (sdkLoaded) { Pi.init({ version: "2.0", sandbox: true }); initOK = true; } 
    } catch(e){}
    row(initOK, 'Pi.init executed (sandbox mode)');

    // 3) Auth + Payments present
    row(!!(sdkLoaded && Pi.authenticate), 'Pi.authenticate available');
    row(!!(sdkLoaded && Pi.createPayment), 'Pi.createPayment available');

    // 4) Legal pages + validation key
    async function urlOk(u){
      try { const r = await fetch(u, {method:'HEAD'}); return r.ok; } catch { return false; }
    }
    const privacyOk = await urlOk('/privacy.html');
    row(privacyOk, 'Privacy Policy reachable (/privacy.html)');
    const termsOk = await urlOk('/terms.html');
    row(termsOk, 'Terms reachable (/terms.html)');
    const valOk = await urlOk('/validation-key.txt');
    row(valOk, 'validation-key.txt reachable');

    el.innerHTML = `<div style="padding:10px;border:1px solid #eee;border-radius:8px;background:#fafafa">
      <strong>Pi Sandbox Readiness</strong>
      ${rows.join('')}
    </div>`;
    console.log('Pi Sandbox Readiness Report:\n' + rows.map(r=>r.replace(/<[^>]*>/g,'')).join('\n'));
  }
  window.addEventListener('load', runPiSandboxCheck);
</script>
<footer style="margin-top:40px; padding:12px; font-size:13px; text-align:center; color:#666; border-top:1px solid #eee;">
  <p>
    <a href="/privacy.html" style="color:#6A1B9A; text-decoration:none;">Privacy Policy</a> ·
    <a href="/terms.html" style="color:#6A1B9A; text-decoration:none;">Terms of Use</a>
  </p>
  <p class="tiny">© 2025 Musiq Studio on Pi</p>
</footer>

</body>
</html>
