<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Musiq Studio on Pi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <!-- Fonts (system fallbacks) -->
  <style>
    :root{
      --bg1:#0f1020; --bg2:#1b1636; --card:#ffffff15; --stroke:#ffffff22; --text:#f5f7ff;
      --accent:#8b5cf6; --accent2:#22d3ee; --muted:#c4c7d1; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --btn:#ffffff14; --btn-hover:#ffffff25;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      background: radial-gradient(1200px 700px at 10% -10%, #322b63 0%, transparent 60%),
                  radial-gradient(1200px 700px at 110% 20%, #0ea5e9 0%, transparent 55%),
                  linear-gradient(160deg, var(--bg1), var(--bg2));
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    header{
      padding:28px 20px 8px; text-align:center;
    }
    .title{
      font-size: clamp(28px, 3.8vw, 44px); font-weight:800; letter-spacing:.3px; margin:0;
      background: linear-gradient(90deg, #fff 0%, #d1d5ff 40%, #a5f3fc 100%);
      -webkit-background-clip: text; background-clip:text; color:transparent;
    }
    .subtitle{
      margin:6px 0 0; color:var(--muted); font-size:14px;
    }

    .wrap{
      max-width:1000px; margin:24px auto 70px; padding:0 16px;
    }
    .card{
      background: var(--card); backdrop-filter: blur(10px);
      border:1px solid var(--stroke); border-radius:16px; padding:18px;
      box-shadow: 0 10px 30px #00000030;
    }

    .toolbar{
      display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 6px;
    }
    .btn{
      appearance:none; border:1px solid var(--stroke); background:var(--btn);
      color:var(--text); padding:10px 14px; border-radius:10px; cursor:pointer;
      font-weight:600; letter-spacing:.2px; transition:.15s transform, .15s background;
    }
    .btn:hover{ background:var(--btn-hover); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none }

    .btn-primary{ border-color:transparent; background: linear-gradient(90deg, var(--accent), var(--accent2)); color:#0b1020; }
    .btn-primary:hover{ filter:brightness(1.06); }

    .status{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px; margin:8px 0 14px;
      background:#0b1222; border:1px solid #203055; border-radius:12px; font-size:14px;
      min-height:40px;
    }
    .chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background:#ffffff10; font-size:12px; color:var(--muted)}
    .ok{ color:var(--ok) } .warn{ color:var(--warn) } .err{ color:var(--err) }

    .grid{ display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; }
    @media (max-width:900px){ .grid{ grid-template-columns: 1fr; } }

    .panel{ background:#0b1020aa; border:1px solid var(--stroke); border-radius:14px; padding:14px; }
    .panel h3{ margin:0 0 10px; font-size:16px; color:#dbeafe; letter-spacing:.3px }

    .media{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
    audio{ width:100%; margin-top:8px }

    footer{
      max-width:1000px; margin:18px auto 90px; padding:0 16px; color:var(--muted); font-size:13px; text-align:center;
    }
    footer a{ color:#a5f3fc; text-decoration:none }
    footer a:hover{ text-decoration:underline }

    /* Debug bar (fixed bottom) */
    #debug-bar{
      position:fixed; left:0; right:0; bottom:0; max-height:34vh; overflow:auto;
      background:#05070e; color:#c7e0ff; font:12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      border-top:1px solid #1f2a44; z-index:9999; padding:8px 10px;
      box-shadow: 0 -8px 24px #00000050;
    }
    #debug-bar .line{ white-space:pre-wrap; word-break:break-word; opacity:.95 }
    .badge{ font-size:11px; padding:2px 6px; border-radius:6px; background:#111827; border:1px solid #25314d; color:#9fb4d9 }
  </style>
</head>
<body>
  <header>
    <h1 class="title">üé∂ Musiq Studio on Pi</h1>
    <p class="subtitle">Create ‚Ä¢ Record ‚Ä¢ Mint ‚Ä¢ Trade ‚Äî powered by Pi Network</p>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="toolbar">
        <button class="btn btn-primary" id="btn-login">üîë Login with Pi</button>
        <span class="chip" id="whoami">Not signed in</span>
        <span class="chip" id="pi-chip">SDK: <span id="pi-state">booting‚Ä¶</span></span>
      </div>

      <div class="status" id="status">Initializing‚Ä¶</div>

      <div class="grid">
        <!-- Studio panel -->
        <div class="panel">
          <h3>Studio</h3>
          <div class="media">
            <button class="btn" id="btn-load">üìÇ Load Track</button>
            <button class="btn" id="btn-record">üé§ Record / Stop</button>
            <span class="chip">‚è±Ô∏è <span id="rec-timer">00:00</span></span>
          </div>
          <audio id="preview-audio" controls style="display:none"></audio>
        </div>

        <!-- Pi panel -->
        <div class="panel">
          <h3>Pi Actions</h3>
          <div class="media">
            <button class="btn" id="btn-mint">ü™ô Mint NFT (1œÄ sandbox)</button>
            <button class="btn" id="btn-market">üõçÔ∏è Market</button>
          </div>
          <p style="margin:10px 0 0;color:var(--muted);font-size:13px">
            Tip: Open this site in the <strong>Pi Browser</strong> for login & payments.
          </p>
        </div>
      </div>
    </section>
  </main>

  <!-- Debug Bar -->
  <div id="debug-bar"></div>

  <!-- App Script -->
  <script>
    // --- tiny debug helper to print on page ---
    const dbg = (msg) => {
      try { console.log(msg); } catch(_) {}
      const bar = document.getElementById('debug-bar');
      const line = document.createElement('div'); line.className='line';
      line.textContent = new Date().toLocaleTimeString() + " ‚Äî " + msg;
      bar.appendChild(line);
      while (bar.childNodes.length > 140) bar.removeChild(bar.firstChild);
    };

    // --- DOM helpers ---
    const $ = (id)=>document.getElementById(id);
    const setStatus = (html)=>{ $('status').innerHTML = html };
    const setPiState = (t)=>{ $('pi-state').textContent = t };
    const setWho = (t)=>{ $('whoami').textContent = t };

    // --- enable/disable action buttons until login ---
    function enableActions(enabled){
      ['btn-load','btn-record','btn-mint','btn-market']
        .forEach(id => { const el = $(id); if(el) el.disabled = !enabled; });
    }

    // --- Pi SDK init (sandbox) ---
    function initPi(){
      if(!window.Pi){ setPiState('‚ùå not loaded'); setStatus('‚ùå Pi SDK not loaded'); return; }
      try{
        Pi.init({ version:'2.0', sandbox:true });
        setPiState('‚úÖ ready (sandbox)');
        setStatus('‚úÖ Pi SDK initialized (sandbox)');
        dbg('[SDK] Pi.init done (sandbox)');
      }catch(e){
        setPiState('‚ùå init error');
        setStatus('‚ùå Pi.init failed: ' + (e?.message || e));
        dbg('[SDK] init error: ' + (e?.message || e));
      }
    }

    // --- Login (username + payments) ---
    let currentUser = null;
    async function loginWithPi(){
      if(!window.Pi){ alert('Open in Pi Browser to login.'); return; }
      try{
        const auth = await Pi.authenticate(['username','payments']);
        currentUser = auth?.user || null;
        const name = currentUser?.username || 'Pioneer';
        setWho('Signed in: ' + name + ' üéâ');
        setStatus('‚úÖ Logged in as ' + name);
        enableActions(true);
        dbg('[AUTH] success for ' + name);
      }catch(e){
        setStatus('‚ùå Login failed: ' + (e?.message || e));
        dbg('[AUTH] error: ' + (e?.message || e));
      }
    }

    // --- Confirm payments scope when minting ---
    async function ensurePaymentsScope(){
      try{
        await Pi.authenticate(['payments']); // no-op if already granted
        return true;
      }catch(e){
        alert("Mint requires 'payments' permission.");
        dbg('[AUTH] payments scope error: ' + (e?.message || e));
        return false;
      }
    }

    // --- Mint flow with full client logging ---
    async function onMintNft(){
      if(!currentUser){ alert('Please login first.'); return; }
      if(!(await ensurePaymentsScope())) return;

      const paymentData = {
        amount: 1,
        memo: "Musiq Studio ‚Äì Mint demo",
        metadata: { feature: "mint_demo" }
      };
      dbg('[CLIENT] createPayment start ' + JSON.stringify(paymentData));

      try{
        await Pi.createPayment(paymentData, {
          onReadyForServerApproval: async (paymentId) => {
            setStatus('‚è≥ Approving payment‚Ä¶'); dbg('[CLIENT] Approve start id=' + paymentId);
            try{
              const r = await fetch('/.netlify/functions/approve-payment', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ paymentId })
              });
              const t = await r.text(); dbg('[CLIENT] Approve response ' + r.status + ' ' + t);
              if(!r.ok){ setStatus(`‚ùå Approve failed: ${r.status}`); alert(`Approve failed: ${r.status}\n${t}`); return; }
            }catch(err){ dbg('[CLIENT] Approve fetch error: ' + (err?.message||err)); setStatus('‚ùå Approve fetch error'); }
          },
          onReadyForServerCompletion: async (paymentId, txId) => {
            setStatus('‚è≥ Completing payment‚Ä¶'); dbg('[CLIENT] Complete start id=' + paymentId + ' tx=' + (txId||'none'));
            try{
              const r = await fetch('/.netlify/functions/complete-payment', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ paymentId, txId })
              });
              const t = await r.text(); dbg('[CLIENT] Complete response ' + r.status + ' ' + t);
              if(!r.ok){ setStatus(`‚ùå Complete failed: ${r.status}`); alert(`Complete failed: ${r.status}\n${t}`); return; }
              setStatus(`‚úÖ Payment completed! ID: ${paymentId}${txId ? `, tx: ${txId}` : ''}`);
              dbg('[CLIENT] Payment flow finished ‚úÖ');
            }catch(err){ dbg('[CLIENT] Complete fetch error: ' + (err?.message||err)); setStatus('‚ùå Complete fetch error'); }
          },
          onCancel: (paymentId) => { setStatus('‚ùå Payment cancelled.'); dbg('[CLIENT] Payment cancelled ' + (paymentId||'')); },
          onError:  (error, paymentId) => {
            const msg = (error?.message || String(error));
            setStatus('‚ùå Payment error: ' + msg);
            dbg('[CLIENT] Payment error ' + (paymentId||'') + ' ' + msg);
            alert('Payment error: ' + msg);
          }
        });
      }catch(e){
        setStatus('‚ùå Mint failed: ' + (e?.message || e));
        dbg('[CLIENT] createPayment threw: ' + (e?.message || e));
      }
    }

    // --- Simple audio tools (load, record, timer) ---
    let mediaRecorder=null, mediaStream=null, recordedChunks=[], recording=false, timerInt=null, tSec=0;

    function fmtTime(s){ const m=Math.floor(s/60).toString().padStart(2,'0'); const ss=(s%60).toString().padStart(2,'0'); return `${m}:${ss}`; }
    function startTimer(){ clearInterval(timerInt); tSec=0; $('rec-timer').textContent=fmtTime(0); timerInt=setInterval(()=>{ $('rec-timer').textContent=fmtTime(++tSec); },1000); }
    function stopTimer(){ clearInterval(timerInt); }

    function onLoadTrack(){
      const input=document.createElement('input'); input.type='file'; input.accept='audio/*';
      input.onchange=()=>{
        const f=input.files?.[0]; if(!f) return;
        const url=URL.createObjectURL(f);
        const audio=$('preview-audio'); audio.src=url; audio.style.display='block';
        audio.play().catch(()=>{});
        setStatus('üìÇ Loaded: ' + f.name); dbg('[AUDIO] loaded ' + f.name);
      };
      input.click();
    }

    async function toggleRecord(){
      const audio=$('preview-audio');
      if(!recording){
        try{
          const s = await navigator.mediaDevices.getUserMedia({audio:true});
          mediaStream = s; recordedChunks = [];
          mediaRecorder = new MediaRecorder(s);
          mediaRecorder.ondataavailable = e => { if(e.data.size) recordedChunks.push(e.data); };
          mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, {type:'audio/webm'});
            const url = URL.createObjectURL(blob);
            audio.src = url; audio.style.display='block';
            setStatus('‚èπÔ∏è Recording stopped; preview ready.'); dbg('[AUDIO] recorded ' + Math.round(blob.size/1024) + ' KB');
          };
          mediaRecorder.start(); recording=true; startTimer();
          setStatus('üé§ Recording‚Ä¶'); dbg('[AUDIO] recording started');
        }catch(e){
          alert('Microphone permission failed.'); dbg('[AUDIO] mic error: ' + (e?.message||e));
        }
      }else{
        mediaRecorder?.stop(); mediaStream?.getTracks()?.forEach(t=>t.stop());
        recording=false; stopTimer(); dbg('[AUDIO] recording stopped');
      }
    }

    // --- Nav ---
    function goMarket(){ location.href='/market.html'; }

    // --- Wire up on load ---
    window.addEventListener('load', ()=>{
      enableActions(false);
      initPi();
      $('btn-login').onclick  = loginWithPi;
      $('btn-load').onclick   = onLoadTrack;
      $('btn-record').onclick = toggleRecord;
      $('btn-mint').onclick   = onMintNft;
      $('btn-market').onclick = goMarket;

      // gentle banner if not in Pi Browser
      const ua = navigator.userAgent||'';
      if(!/PiBrowser/i.test(ua)){
        const w=document.createElement('div');
        w.style.cssText="position:fixed;left:0;right:0;top:0;background:#fde68a;color:#111;padding:10px 12px;border-bottom:1px solid #eab308;z-index:99999;text-align:center;font-weight:600";
        w.innerHTML="Open this site in the <b>Pi Browser</b> app for login & payments.";
        document.body.appendChild(w);
      }
    });
  </script>

  <footer>
    <p><a href="/privacy.html">Privacy Policy</a> ¬∑ <a href="/terms.html">Terms of Use</a></p>
    <p class="tiny">¬© 2025 Musiq Studio on Pi ‚Äî crafted with ‚ù§Ô∏è</p>
  </footer>
</body>
</html>
